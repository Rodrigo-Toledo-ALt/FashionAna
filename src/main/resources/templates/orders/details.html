<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout :: head(~{::title})}"> 
    <title>Detalles de Pedido | FashionAna</title>
</head>
<body>
    <header th:replace="~{layout :: header}"></header>

    <main class="container py-4" th:fragment="content">
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/orders">Pedidos</a></li>
                <li class="breadcrumb-item active" aria-current="page">Pedido #<span th:text="${order.id}"></span></li>
            </ol>
        </nav>
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Detalles del Pedido #<span th:text="${order.id}"></span></h1>
            <div th:if="${session.userType == 'employee'}">
                <a th:href="@{/orders/{id}/edit(id=${order.id})}" class="btn btn-warning me-2">Editar</a>
                <a th:href="@{/orders}" class="btn btn-secondary">Volver</a>
            </div>
            <div th:unless="${session.userType == 'employee'}">
                <a href="javascript:history.back()" class="btn btn-secondary">Volver</a>
            </div>
        </div>
        
        <!-- Estado del pedido -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h3 class="card-title mb-0">Estado del Pedido</h3>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h4>Estado actual: 
                            <span class="badge" th:classappend="${
                                order.status == T(org.example.fashionana.Modelos.OrderStatus).PENDING ? 'bg-warning' : 
                                order.status == T(org.example.fashionana.Modelos.OrderStatus).PROCESSING ? 'bg-info' : 
                                order.status == T(org.example.fashionana.Modelos.OrderStatus).SHIPPED ? 'bg-primary' : 
                                order.status == T(org.example.fashionana.Modelos.OrderStatus).DELIVERED ? 'bg-success' : 
                                order.status == T(org.example.fashionana.Modelos.OrderStatus).CANCELLED ? 'bg-danger' : 'bg-secondary'
                            }" th:text="${order.status}"></span>
                        </h4>
                        <p>Fecha del pedido: <span th:text="${#dates.format(order.orderDate, 'dd/MM/yyyy HH:mm')}"></span></p>
                        <p th:if="${order.updatedAt != null}">Última actualización: <span th:text="${#dates.format(order.updatedAt, 'dd/MM/yyyy HH:mm')}"></span></p>
                    </div>
                    <div class="col-md-6" th:if="${session.userType == 'employee'}">
                        <form th:action="@{/orders/{id}/update-status(id=${order.id})}" method="post" class="d-flex gap-2">
                            <select class="form-select" name="newStatus" required>
                                <option value="">Cambiar estado...</option>
                                <option th:each="status : ${statuses}" th:value="${status}" th:text="${status}" th:selected="${status == order.status}"></option>
                            </select>
                            <button type="submit" class="btn btn-primary">Actualizar</button>
                        </form>
                    </div>
                </div>
                
                <!-- Timeline de estados -->
                <div class="mt-4">
                    <div class="position-relative m-4">
                        <div class="progress" style="height: 3px;">
                            <div class="progress-bar" role="progressbar" th:style="'width: ' + ${
                                order.status == T(org.example.fashionana.Modelos.OrderStatus).PENDING ? '20%' : 
                                order.status == T(org.example.fashionana.Modelos.OrderStatus).PROCESSING ? '40%' : 
                                order.status == T(org.example.fashionana.Modelos.OrderStatus).SHIPPED ? '60%' : 
                                order.status == T(org.example.fashionana.Modelos.OrderStatus).DELIVERED ? '100%' : 
                                order.status == T(org.example.fashionana.Modelos.OrderStatus).CANCELLED ? '0%' : '0%'
                            }" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="position-absolute top-0 translate-middle" style="left: 0%">
                            <div class="rounded-circle border border-3" th:classappend="${order.status != T(org.example.fashionana.Modelos.OrderStatus).CANCELLED ? 'bg-success border-success' : 'bg-secondary border-secondary'}" style="width: 15px; height: 15px;"></div>
                            <p class="small mt-1">Pedido realizado</p>
                        </div>
                        <div class="position-absolute top-0 translate-middle" style="left: 20%">
                            <div class="rounded-circle border border-3" th:classappend="${order.status != T(org.example.fashionana.Modelos.OrderStatus).PENDING && order.status != T(org.example.fashionana.Modelos.OrderStatus).CANCELLED ? 'bg-success border-success' : (order.status == T(org.example.fashionana.Modelos.OrderStatus).PENDING ? 'bg-warning border-warning' : 'bg-secondary border-secondary')}" style="width: 15px; height: 15px;"></div>
                            <p class="small mt-1">Pendiente</p>
                        </div>
                        <div class="position-absolute top-0 translate-middle" style="left: 40%">
                            <div class="rounded-circle border border-3" th:classappend="${order.status == T(org.example.fashionana.Modelos.OrderStatus).PROCESSING ? 'bg-info border-info' : (order.status == T(org.example.fashionana.Modelos.OrderStatus).SHIPPED || order.status == T(org.example.fashionana.Modelos.OrderStatus).DELIVERED ? 'bg-success border-success' : 'bg-secondary border-secondary')}" style="width: 15px; height: 15px;"></div>
                            <p class="small mt-1">Procesando</p>
                        </div>
                        <div class="position-absolute top-0 translate-middle" style="left: 60%">
                            <div class="rounded-circle border border-3" th:classappend="${order.status == T(org.example.fashionana.Modelos.OrderStatus).SHIPPED ? 'bg-primary border-primary' : (order.status == T(org.example.fashionana.Modelos.OrderStatus).DELIVERED ? 'bg-success border-success' : 'bg-secondary border-secondary')}" style="width: 15px; height: 15px;"></div>
                            <p class="small mt-1">Enviado</p>
                        </div>
                        <div class="position-absolute top-0 translate-middle" style="left: 100%">
                            <div class="rounded-circle border border-3" th:classappend="${order.status == T(org.example.fashionana.Modelos.OrderStatus).DELIVERED ? 'bg-success border-success' : 'bg-secondary border-secondary'}" style="width: 15px; height: 15px;"></div>
                            <p class="small mt-1">Entregado</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- Información del cliente -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <h3 class="card-title mb-0">Información del Cliente</h3>
                    </div>
                    <div class="card-body">
                        <h5 th:text="${order.customer != null ? order.customer.firstName + ' ' + order.customer.lastName : 'Cliente no disponible'}"></h5>
                        <p th:if="${order.customer != null}">
                            <strong>Email:</strong> <span th:text="${order.customer.email}"></span><br>
                            <strong>Teléfono:</strong> <span th:text="${order.customer.phone}"></span>
                        </p>
                        <div class="mt-3" th:if="${order.customer != null}">
                            <a th:href="@{/customers/{id}(id=${order.customer.id})}" class="btn btn-outline-primary">Ver perfil completo</a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Información de envío y pago -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <h3 class="card-title mb-0">Información de Envío y Pago</h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <h5>Dirección de Envío</h5>
                            <p th:if="${order.shippingAddress != null}">
                                <span th:text="${order.shippingAddress.street}"></span><br>
                                <span th:text="${order.shippingAddress.city}"></span>, <span th:text="${order.shippingAddress.state}"></span><br>
                                <span th:text="${order.shippingAddress.postalCode}"></span>, <span th:text="${order.shippingAddress.country}"></span>
                            </p>
                            <p th:unless="${order.shippingAddress != null}">No disponible</p>
                        </div>
                        <div>
                            <h5>Método de Pago</h5>
                            <p th:if="${order.paymentMethod != null}">
                                <span th:text="${order.paymentMethod.type}"></span><br>
                                <span th:if="${order.paymentMethod.cardNumber != null}">
                                    Tarjeta: **** **** **** <span th:text="${#strings.substring(order.paymentMethod.cardNumber, order.paymentMethod.cardNumber.length() - 4)}"></span>
                                </span>
                            </p>
                            <p th:unless="${order.paymentMethod != null}">No disponible</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Detalles de los productos -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h3 class="card-title mb-0">Productos del Pedido</h3>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Precio unitario</th>
                                <th>Cantidad</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="item : ${order.items}">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img th:if="${item.product != null && item.product.imageUrl != null}" th:src="${item.product.imageUrl}" class="img-thumbnail me-2" style="width: 50px; height: 50px;" alt="Imagen del producto">
                                        <div>
                                            <span th:text="${item.product != null ? item.product.name : 'Producto no disponible'}"></span><br>
                                            <small class="text-muted" th:if="${item.productVariant != null}" th:text="${item.productVariant.name}"></small>
                                        </div>
                                    </div>
                                </td>
                                <td th:text="${#numbers.formatCurrency(item.price)}"></td>
                                <td th:text="${item.quantity}"></td>
                                <td th:text="${#numbers.formatCurrency(item.price * item.quantity)}"></td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-end"><strong>Subtotal:</strong></td>
                                <td th:text="${#numbers.formatCurrency(order.subtotal)}"></td>
                            </tr>
                            <tr th:if="${order.taxAmount != null}">
                                <td colspan="3" class="text-end">Impuestos:</td>
                                <td th:text="${#numbers.formatCurrency(order.taxAmount)}"></td>
                            </tr>
                            <tr th:if="${order.shippingCost != null}">
                                <td colspan="3" class="text-end">Costo de envío:</td>
                                <td th:text="${#numbers.formatCurrency(order.shippingCost)}"></td>
                            </tr>
                            <tr th:if="${order.discount != null && order.discount > 0}">
                                <td colspan="3" class="text-end">Descuento:</td>
                                <td th:text="${#numbers.formatCurrency(order.discount)}"></td>
                            </tr>
                            <tr>
                                <td colspan="3" class="text-end"><strong>Total:</strong></td>
                                <td><strong th:text="${#numbers.formatCurrency(order.totalAmount)}"></strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Historial de estados -->
        <div class="card mb-4" th:if="${order.statusHistory != null && !order.statusHistory.isEmpty()}">
            <div class="card-header bg-primary text-white">
                <h3 class="card-title mb-0">Historial de Estados</h3>
            </div>
            <div class="card-body">
                <ul class="list-group">
                    <li class="list-group-item" th:each="statusChange : ${order.statusHistory}">
                        <div class="d-flex justify-content-between">
                            <div>
                                <span class="badge" th:classappend="${
                                    statusChange.status == T(org.example.fashionana.Modelos.OrderStatus).PENDING ? 'bg-warning' : 
                                    statusChange.status == T(org.example.fashionana.Modelos.OrderStatus).PROCESSING ? 'bg-info' : 
                                    statusChange.status == T(org.example.fashionana.Modelos.OrderStatus).SHIPPED ? 'bg-primary' : 
                                    statusChange.status == T(org.example.fashionana.Modelos.OrderStatus).DELIVERED ? 'bg-success' : 
                                    statusChange.status == T(org.example.fashionana.Modelos.OrderStatus).CANCELLED ? 'bg-danger' : 'bg-secondary'
                                }" th:text="${statusChange.status}"></span>
                                <span th:if="${statusChange.comment != null && !statusChange.comment.isEmpty()}" th:text="${statusChange.comment}"></span>
                            </div>
                            <small class="text-muted" th:text="${#dates.format(statusChange.changedAt, 'dd/MM/yyyy HH:mm')}"></small>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </main>

    <footer th:replace="~{layout :: footer}"></footer>
</body>
</html>